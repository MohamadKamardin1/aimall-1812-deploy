<!-- admin_dashboard/templates/admin_dashboard/products/edit_product.html -->
{% extends 'admin_dashboard/base.html' %}
{% load static %}

{% block title %}Edit Product - {{ product.name }}{% endblock %}
{% block page_title %}Edit Product Template{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-8">
    <div class="dashboard-card">
      <div class="card-header">
        <h6 class="title-medium mb-0">Edit Product: "{{ product.name }}"</h6>
      </div>
      <div class="card-body">
        <form method="post" enctype="multipart/form-data" id="productForm">
          {% csrf_token %}
          
          <!-- Product Name -->
          <div class="mb-3">
            <label class="form-label body-medium">Product Name *</label>
            {{ form.name }}
            {% if form.name.errors %}
              <div class="text-danger body-small">{{ form.name.errors }}</div>
            {% endif %}
          </div>

          <!-- Category -->
          <div class="mb-3">
            <label class="form-label body-medium">Category *</label>
            {{ form.category }}
            {% if form.category.errors %}
              <div class="text-danger body-small">{{ form.category.errors }}</div>
            {% endif %}
          </div>

          <!-- Primary Unit Type -->
          <div class="mb-3">
            <label class="form-label body-medium">Primary Unit Type *</label>
            {{ form.primary_unit_type }}
            {% if form.primary_unit_type.errors %}
              <div class="text-danger body-small">{{ form.primary_unit_type.errors }}</div>
            {% endif %}
          </div>

          <!-- Available Units -->
          <div class="mb-3">
            <label class="form-label body-medium">Available Units</label>
            <div id="availableUnitsContainer" class="d-flex flex-wrap gap-2">
              <!-- Dynamic content will be loaded here by JavaScript -->
            </div>
            <div id="noUnitsMessage" class="body-small text-muted mt-2" style="display: none;">
              Select a Primary Unit Type to see available units.
            </div>
            {% if form.available_units.errors %}
              <div class="text-danger body-small">{{ form.available_units.errors }}</div>
            {% endif %}
          </div>

          <!-- Description -->
          <div class="mb-3">
            <label class="form-label body-medium">Description</label>
            {{ form.description }}
          </div>

          <!-- Search Keywords -->
          <div class="mb-3">
            <label class="form-label body-medium">Search Keywords</label>
            {{ form.search_keywords }}
            <div class="form-text">Comma-separated keywords to improve search</div>
            {% if form.search_keywords.errors %}
              <div class="text-danger body-small">{{ form.search_keywords.errors }}</div>
            {% endif %}
          </div>

          <!-- Active Toggle -->
          <div class="form-check mb-3">
            {{ form.is_active }}
            <label class="form-check-label body-medium" for="{{ form.is_active.id_for_label }}">Active (visible to customers)</label>
          </div>

          <!-- Non-field errors -->
          {% if form.non_field_errors %}
            <div class="alert alert-danger body-small">
              {{ form.non_field_errors }}
            </div>
          {% endif %}

          <!-- Submit -->
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-1"></i> Update Product
            </button>
            <a href="{% url 'admin_dashboard:product-detail' product.id %}" class="btn btn-outline-secondary">Cancel</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Sidebar: Image Upload -->
  <div class="col-lg-4">
    <div class="dashboard-card">
      <div class="card-header">
        <h6 class="title-medium mb-0">Product Image</h6>
      </div>
      <div class="card-body">
        <div class="mb-3 text-center">
          <div id="imagePreview" class="mb-3" style="min-height: 150px; display: flex; align-items: center; justify-content: center; background: var(--surface-variant); border-radius: var(--border-radius);">
            {% if product.main_image %}
              <img src="{{ product.main_image.url }}" alt="Preview" class="img-fluid" style="max-height: 150px; object-fit: contain;">
            {% else %}
              <i class="fas fa-image fa-3x text-muted"></i>
            {% endif %}
          </div>
          <input type="file" name="main_image" id="main_image" class="form-control" accept="image/*">
          <div class="form-text body-small">Leave blank to keep current image. Max size: 5MB. Formats: JPG, PNG</div>
          {% if form.main_image.errors %}
            <div class="text-danger body-small mt-1">{{ form.main_image.errors }}</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Product Info -->
    <div class="dashboard-card mt-4">
      <div class="card-header">
        <h6 class="title-medium mb-0">Product Details</h6>
      </div>
      <div class="card-body">
        <p class="body-medium">
          <strong>Created:</strong> {{ product.created_at|date:"M d, Y H:i" }}
        </p>
        <p class="body-medium">
          <strong>Last Updated:</strong> {{ product.updated_at|date:"M d, Y H:i" }}
        </p>
        <p class="body-medium">
          <strong>SKU:</strong> {{ product.sku|default:"Not set" }}
        </p>
        <p class="body-medium">
          <strong>Slug:</strong> {{ product.slug }}
        </p>
        <p class="body-medium">
          <strong>Status:</strong> 
          <span class="badge {% if product.is_active %}bg-success{% else %}bg-danger{% endif %}">
            {% if product.is_active %}Active{% else %}Inactive{% endif %}
          </span>
          <span class="badge {% if product.is_verified %}bg-info{% else %}bg-warning{% endif %}">
            {% if product.is_verified %}Verified{% else %}Unverified{% endif %}
          </span>
        </p>
        <hr>
        <div class="d-grid">
          <a href="{% url 'admin_dashboard:product-detail' product.id %}" class="btn btn-outline-primary">
            <i class="fas fa-eye me-1"></i> View Product Details
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Handle image preview
document.getElementById('main_image').addEventListener('change', function(e) {
  const preview = document.getElementById('imagePreview');
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="img-fluid" style="max-height: 150px; object-fit: contain;">`;
    };
    reader.readAsDataURL(file);
  }
});

// Unit type change handler
document.getElementById('{{ form.primary_unit_type.id_for_label }}').addEventListener('change', function() {
  const unitTypeId = this.value;
  const container = document.getElementById('availableUnitsContainer');
  const noUnitsMsg = document.getElementById('noUnitsMessage');
  
  container.innerHTML = '';
  
  if (!unitTypeId) {
    noUnitsMsg.style.display = 'block';
    return;
  }
  
  noUnitsMsg.style.display = 'none';
  
  // Get units from preloaded JSON
  const units = {{ unit_groups_json|safe }};
  const selectedType = units.find(ut => ut.unit_type.id == unitTypeId);
  
  if (selectedType && selectedType.units.length > 0) {
    // Get selected IDs from form initial data
    const selectedIds = {{ selected_unit_ids|safe }};
    
    selectedType.units.forEach(unit => {
      let isChecked = selectedIds.includes(unit.id.toString()) ? ' checked' : '';
      const html = `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="available_units" value="${unit.id}" id="unit_${unit.id}"${isChecked}>
          <label class="form-check-label body-small" for="unit_${unit.id}">${unit.name} (${unit.symbol})</label>
        </div>
      `;
      container.innerHTML += html;
    });
  } else {
    container.innerHTML = '<span class="body-small text-muted">No active units for this type.</span>';
  }
});

// Trigger initial load if a primary unit type is pre-selected
document.addEventListener('DOMContentLoaded', function() {
  const primarySelect = document.getElementById('{{ form.primary_unit_type.id_for_label }}');
  if (primarySelect.value) {
    primarySelect.dispatchEvent(new Event('change'));
  } else {
    document.getElementById('noUnitsMessage').style.display = 'block';
  }
});
</script>
{% endblock %}