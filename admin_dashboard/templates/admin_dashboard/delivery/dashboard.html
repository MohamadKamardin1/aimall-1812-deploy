<!-- admin_dashboard/templates/admin_dashboard/delivery/dashboard.html -->
{% extends 'admin_dashboard/base.html' %}
{% load static %}

{% block title %}Delivery Dashboard - AI Mall Admin{% endblock %}
{% block page_title %}Delivery Dashboard{% endblock %}

{% block extra_css %}
<style>
  .delivery-metric {
    text-align: center;
    padding: 1rem;
    border-radius: 8px;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: transform 0.2s;
  }
  .delivery-metric:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  .metric-icon {
    font-size: 1.8rem;
    margin-bottom: 0.5rem;
    opacity: 0.8;
  }
  .metric-value {
    font-size: 2rem;
    font-weight: 700;
    margin: 0.5rem 0;
  }
  .metric-label {
    font-size: 0.85rem;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .recent-item {
    padding: 0.75rem;
    border-bottom: 1px solid #eee;
    transition: background 0.2s;
  }
  .recent-item:hover {
    background: #f8f9fa;
  }
  .recent-item:last-child {
    border-bottom: none;
  }
</style>
{% endblock %}

{% block content %}
<!-- Top Stats Row -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="dashboard-card p-3">
      <div class="title-medium text-primary">{{ total_delivery_zones }}</div>
      <small class="text-muted">Delivery Zones</small>
      <div class="mt-2">
        <small class="text-success">{{ active_delivery_zones }} active</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="dashboard-card p-3">
      <div class="title-medium text-success">{{ total_markets }}</div>
      <small class="text-muted">Markets</small>
      <div class="mt-2">
        <small class="text-muted">With delivery service</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="dashboard-card p-3">
      <div class="title-medium text-info">{{ total_customer_addresses }}</div>
      <small class="text-muted">Customer Addresses</small>
      <div class="mt-2">
        <small class="text-warning">{{ recent_addresses|length }} recent</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="dashboard-card p-3">
      <div class="title-medium {% if fee_config_active %}text-success{% else %}text-warning{% endif %}">
        {{ fee_config_name }}
      </div>
      <small class="text-muted">Fee Configuration</small>
      <div class="mt-2">
        <small class="{% if fee_config_active %}text-success{% else %}text-danger{% endif %}">
          {% if fee_config_active %}Active{% else %}Not configured{% endif %}
        </small>
      </div>
    </div>
  </div>
</div>

<!-- Main Content Row -->
<div class="row">
  <!-- Left Column: Quick Actions & Recent Zones -->
  <div class="col-md-8">
    <!-- Quick Actions -->
    <div class="dashboard-card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="title-medium mb-0">Quick Actions</h6>
        <span class="text-muted small">Manage delivery operations</span>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="d-grid gap-2">
              <a href="{% url 'admin_dashboard:manage-delivery-fee-configs' %}" class="btn btn-primary">
                <i class="fas fa-calculator me-2"></i> Manage Fee Config
              </a>
              <a href="{% url 'admin_dashboard:manage-delivery-time-slots' %}" class="btn btn-outline-info">
                <i class="fas fa-clock me-2"></i> Time Slots
              </a>
              <a href="{% url 'admin_dashboard:delivery-analytics' %}" class="btn btn-outline-secondary">
                <i class="fas fa-chart-line me-2"></i> Delivery Analytics
              </a>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-grid gap-2">
              <a href="{% url 'admin_dashboard:manage-customer-addresses' %}" class="btn btn-success">
                <i class="fas fa-map-marker-alt me-2"></i> Customer Addresses
              </a>
              <a href="{% url 'admin_dashboard:manage-markets' %}" class="btn btn-outline-warning">
                <i class="fas fa-store me-2"></i> Manage Markets
              </a>
              <a href="#" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#helpModal">
                <i class="fas fa-question-circle me-2"></i> Help & Guides
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Delivery Zones -->
    <div class="dashboard-card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="title-medium mb-0">Recent Delivery Zones</h6>
        <span class="text-muted small">Latest {{ recent_zones|length }} zones</span>
      </div>
      <div class="card-body p-0">
        {% if recent_zones %}
          <div class="table-responsive">
            <table class="data-table table mb-0">
              <thead>
                <tr>
                  <th>Zone Name</th>
                  <th>Market</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for zone in recent_zones %}
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="me-2">
                        <i class="fas fa-map-marker-alt text-primary"></i>
                      </div>
                      <div>
                        <div class="title-small">{{ zone.name }}</div>
                        <small class="text-muted">{{ zone.description|truncatechars:30|default:"No description" }}</small>
                      </div>
                    </div>
                  </td>
                  <td>
                    <span class="chip chip-primary">{{ zone.market.name|truncatechars:15 }}</span>
                  </td>
                  <td>
                    <span class="chip {% if zone.zone_type == 'fixed' %}chip-warning{% elif zone.zone_type == 'surcharge' %}chip-info{% else %}chip-success{% endif %}">
                      {{ zone.get_zone_type_display|default:"Standard" }}
                    </span>
                  </td>
                  <td>
                    {% if zone.is_active %}
                      <span class="chip chip-success">Active</span>
                    {% else %}
                      <span class="chip chip-error">Inactive</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="d-flex gap-1">
                      <a href="{% url 'admin_dashboard:delivery-zone-detail' zone.id %}" class="btn btn-outline-primary btn-sm" title="View">
                        <i class="fas fa-eye"></i>
                      </a>
                      <a href="{% url 'admin_dashboard:edit-delivery-zone' zone.id %}" class="btn btn-outline-secondary btn-sm" title="Edit">
                        <i class="fas fa-edit"></i>
                      </a>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="empty-state">
            <i class="fas fa-map-marked-alt"></i>
            <p>No delivery zones found</p>
            <a href="{% url 'admin_dashboard:manage-markets' %}" class="btn btn-primary btn-sm">Create Zones via Markets</a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Right Column: Market Stats & Recent Addresses -->
  <div class="col-md-4">
    <!-- Market Delivery Stats -->
    <div class="dashboard-card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="title-medium mb-0">Market Delivery Stats</h6>
        <span class="badge bg-primary">{{ market_stats|length }}</span>
      </div>
      <div class="card-body">
        {% if market_stats %}
          <div class="list-group list-group-flush">
            {% for market in market_stats %}
            <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 py-2">
              <div class="d-flex align-items-center">
                <i class="fas fa-store text-primary me-2"></i>
                <span>{{ market.name|truncatechars:20 }}</span>
              </div>
              <div class="text-end">
                <div>
                  <span class="badge bg-info rounded-pill">{{ market.zone_count }}</span>
                  <span class="text-muted small ms-1">zones</span>
                </div>
                <small>
                  <a href="{% url 'admin_dashboard:manage-delivery-zones' market.id %}" class="text-decoration-none">
                    Manage
                  </a>
                </small>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state">
            <i class="fas fa-store text-muted"></i>
            <p class="text-muted mb-0">No market data</p>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Recent Customer Addresses -->
    <div class="dashboard-card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="title-medium mb-0">Recent Addresses</h6>
        <span class="badge bg-secondary">{{ recent_addresses|length }}</span>
      </div>
      <div class="card-body p-0">
        {% if recent_addresses %}
          <div class="list-group list-group-flush">
            {% for address in recent_addresses %}
            <div class="list-group-item recent-item">
              <div class="d-flex align-items-start">
                <div class="me-2">
                  {% if address.is_verified %}
                    <i class="fas fa-check-circle text-success"></i>
                  {% else %}
                    <i class="fas fa-clock text-warning"></i>
                  {% endif %}
                </div>
                <div class="flex-grow-1">
                  <div class="title-small">{{ address.address_line1|truncatechars:30 }}</div>
                  <div class="d-flex justify-content-between">
                    <small class="text-muted">{{ address.customer.get_full_name|default:"Unknown" }}</small>
                    <small class="text-muted">{{ address.created_at|timesince }} ago</small>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state">
            <i class="fas fa-map-marker-alt"></i>
            <p>No recent addresses</p>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Time Slots Summary -->
    <div class="dashboard-card">
      <div class="card-header">
        <h6 class="title-medium mb-0">Delivery Time Slots</h6>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <div class="title-medium">{{ total_time_slots }}</div>
            <small class="text-muted">Total slots</small>
          </div>
          <a href="{% url 'admin_dashboard:manage-delivery-time-slots' %}" class="btn btn-outline-primary btn-sm">
            Manage
          </a>
        </div>
        <div class="alert alert-info small mb-0">
          <i class="fas fa-info-circle me-2"></i>
          Configure time slots for order cut-off and delivery windows.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Footer Stats -->
<div class="mt-4 text-muted small">
  <div class="d-flex flex-wrap gap-4">
    <div>
      <i class="fas fa-truck me-1"></i>
      <span>Delivery System Status: <span class="{% if fee_config_active %}text-success{% else %}text-warning{% endif %}">{% if fee_config_active %}Operational{% else %}Setup Required{% endif %}</span></span>
    </div>
    <div>
      <i class="fas fa-clock me-1"></i>
      <span>Last updated: {{ now|date:"F j, Y H:i" }}</span>
    </div>
    <div>
      <i class="fas fa-database me-1"></i>
      <span>{{ total_delivery_zones }} zones across {{ total_markets }} markets</span>
    </div>
  </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delivery Management Help</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <h6><i class="fas fa-map-marker-alt text-primary me-2"></i>Delivery Zones</h6>
          <p class="small text-muted mb-2">Define geographic areas with specific pricing rules. Create zones for different delivery costs based on distance or fixed rates.</p>
        </div>
        <div class="mb-3">
          <h6><i class="fas fa-calculator text-success me-2"></i>Fee Configuration</h6>
          <p class="small text-muted mb-2">Set up base delivery fees, distance rates, and free delivery thresholds.</p>
        </div>
        <div class="mb-3">
          <h6><i class="fas fa-clock text-info me-2"></i>Time Slots</h6>
          <p class="small text-muted mb-2">Configure delivery windows and order cut-off times for better scheduling.</p>
        </div>
        <div class="alert alert-warning small">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Ensure at least one active fee configuration and delivery zones for each market.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <a href="{% url 'admin_dashboard:manage-delivery-fee-configs' %}" class="btn btn-primary">
          Configure Now
        </a>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Update time in footer
  function updateTime() {
    const now = new Date();
    const options = { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    };
    const timeElement = document.querySelector('.time-update');
    if (timeElement) {
      timeElement.textContent = now.toLocaleDateString('en-US', options);
    }
  }
  
  // Update every minute
  setInterval(updateTime, 60000);
  
  // Initialize tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
  
  // Add animation to stats cards
  const statsCards = document.querySelectorAll('.dashboard-card');
  statsCards.forEach((card, index) => {
    card.style.animationDelay = `${index * 0.1}s`;
    card.classList.add('animate__animated', 'animate__fadeInUp');
  });
});
</script>

<style>
.chip {
  display: inline-block;
  padding: 0.25rem 0.6rem;
  font-size: 0.75rem;
  font-weight: 600;
  border-radius: 12px;
  line-height: 1;
}
.chip-primary { background-color: #e3f2fd; color: #1565c0; }
.chip-success { background-color: #e8f5e9; color: #2e7d32; }
.chip-error { background-color: #ffebee; color: #c62828; }
.chip-warning { background-color: #fff3e0; color: #ef6c00; }
.chip-info { background-color: #e0f7fa; color: #006064; }

.empty-state {
  text-align: center;
  padding: 2rem;
}
.empty-state i {
  font-size: 3rem;
  color: #dee2e6;
  margin-bottom: 1rem;
}
.empty-state p {
  color: #6c757d;
  margin-bottom: 1rem;
}

/* Animation */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.animate__animated {
  animation-duration: 0.5s;
}
.animate__fadeInUp {
  animation-name: fadeInUp;
}
</style>
{% endblock %}